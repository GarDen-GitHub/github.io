<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- スマホ対応 -->
  <title>Rasiel Search Mobile - Data</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    #data-container { display: none; }
    #update-time { text-align: center; font-size: 14px; color: gray; }
    table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; } /* スマホでスクロール可能 */
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    @media (max-width: 600px) { body { padding: 10px; } table { font-size: 12px; } }
    #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); text-align: center; padding-top: 200px; font-size: 18px; z-index: 1000; }
  </style>
</head>
<body>
  <div id="data-container">
    <h2>Rasiel Search Mobile</h2>
    <p id="update-time"></p> <!-- 更新日時表示 -->
    <table id="data-table">
      <thead id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  
  <div id="loading">店舗データ読込中...</div> <!-- ローディング表示 -->

  <script>
    // ログイン状態チェック（未ログインならindex.htmlに戻す）
    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'index.html';
    } else {
      document.getElementById('data-container').style.display = 'block';
      fetchData();
    }

    // データ取得と表示
    function fetchData() {
      const apiUrl = 'https://script.google.com/macros/s/AKfycbx-8PrH2Sm7zvCyjPFnst4qRE1BkulkQOvpPupBxxRn_vhtNFsznG2rrLMFhZWxUH8VbA/exec';  // 新しいURL
      
      // ローディング表示
      document.getElementById('loading').style.display = 'block';
      
      fetch(apiUrl)
        .then(response => response.json())
        .then(responseData => {
          const data = responseData.data;
          let updateTime = responseData.updateTime;
          
          // 更新日時のフォーマット変更 (UTC → JST, 2025/07/22 10:38:05形式)
          if (updateTime) {
            const date = new Date(updateTime);
            date.setHours(date.getHours() + 9); // UTC to JST (+9時間)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            updateTime = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
          } else {
            updateTime = '不明';
          }
          document.getElementById('update-time').innerHTML = `データ更新日時: ${updateTime}`;
          
          if (data.length === 0) {
            document.getElementById('table-body').innerHTML = '<tr><td colspan="100%">データがありません。</td></tr>';
          } else {
            // 表示列の定義 (カスタム列名)
            const displayHeaders = [
              '店舗名', '住所', 'P台数', 'S台数',
              'P-WORLD', 'DMM', 'みんパチ', 'Maruhan', 'PIA', 'PsCUBE',
              'Site777', 'PachiPICKS', 'JugglerOnline', 'DAIDATA', 'TERASmobile2',
              'PAPIMO', 'P-moba', 'P-do', 'P-ken', 'P-tora', 'Star', 'Reito',
              'PrimeAI', 'P-ASSiST', 'Star' // LINE_IDをStarとして追加 (重複指定)
            ];
            
            // 都道府県ローマ字マッピング (DMM用)
            const prefMap = {
              '北海道': 'hokkaido', '青森県': 'aomori', '岩手県': 'iwate', '宮城県': 'miyagi', '秋田県': 'akita',
              '山形県': 'yamagata', '福島県': 'fukushima', '茨城県': 'ibaraki', '栃木県': 'tochigi', '群馬県': 'gunma',
              '埼玉県': 'saitama', '千葉県': 'chiba', '東京都': 'tokyo', '神奈川県': 'kanagawa', '新潟県': 'niigata',
              '富山県': 'toyama', '石川県': 'ishikawa', '福井県': 'fukui', '山梨県': 'yamanashi', '長野県': 'nagano',
              '岐阜県': 'gifu', '静岡県': 'shizuoka', '愛知県': 'aichi', '三重県': 'mie', '滋賀県': 'shiga',
              '京都府': 'kyoto', '大阪府': 'osaka', '兵庫県': 'hyogo', '奈良県': 'nara', '和歌山県': 'wakayama',
              '鳥取県': 'tottori', '島根県': 'shimane', '岡山県': 'okayama', '広島県': 'hiroshima', '山口県': 'yamaguchi',
              '徳島県': 'tokushima', '香川県': 'kagawa', '愛媛県': 'ehime', '高知県': 'kochi', '福岡県': 'fukuoka',
              '佐賀県': 'saga', '長崎県': 'nagasaki', '熊本県': 'kumamoto', '大分県': 'oita', '宮崎県': 'miyazaki',
              '鹿児島県': 'kagoshima', '沖縄県': 'okinawa'
            };
            
            // ヘッダー作成
            let headerRow = '<tr>';
            displayHeaders.forEach(header => {
              headerRow += `<th>${header}</th>`;
            });
            headerRow += '</tr>';
            document.getElementById('table-head').innerHTML = headerRow;
            
            // ボディ作成 (カスタム表示)
            let bodyRows = '';
            data.forEach(row => {
              bodyRows += '<tr>';
              
              // 基本列
              bodyRows += `<td>${row['Hall_Name'] || ''}</td>`; // 店舗名
              bodyRows += `<td>${row['Hall_Address'] || ''}</td>`; // 住所
              bodyRows += `<td>${row['P_Units'] || ''}</td>`; // P台数
              bodyRows += `<td>${row['S_Units'] || ''}</td>`; // S台数
              
              // カスタム列 (P-WORLD_ID以降)
              const customColumns = [
                { key: 'P-WORLD_ID', name: 'P-WORLD', link: value => `https://www.p-world.co.jp/sp/hall.cgi?i=${value}` },
                { key: 'DMM_ID', name: 'DMM', link: (value, address) => {
                  const prefName = (address || '').match(/^[^\d]+?[都道府県府]/)?.[0] || '';
                  const prefRoman = prefMap[prefName] || '';
                  return `https://p-town.dmm.com/shops/${prefRoman}/${value}`;
                } },
                { key: 'MinPachi_ID', name: 'みんパチ', link: value => `https://minpachi.com/${value}/` },
                { key: 'Maruhan_ID', name: 'Maruhan', link: null },
                { key: 'PIA_ID', name: 'PIA', link: null },
                { key: 'PsCUBE_URL', name: 'PsCUBE', link: value => value },
                { key: 'Site777_ID', name: 'Site777', link: value => `https://m.site777.jp/f/D0100.do?pmc=${value}` },
                { key: 'PachiPICKS_ID', name: 'PachiPICKS', link: null },
                { key: 'JugglerOnline_ID', name: 'JugglerOnline', link: null },
                { key: 'DAIDATA_Online_ID', name: 'DAIDATA', link: value => `@LINE` in value ? null : `https://daidata.goraggio.com/${value}/` },
                { key: 'TERASmobile2_URL', name: 'TERASmobile2', link: value => value },
                { key: 'PAPIMO_ID', name: 'PAPIMO', link: value => value.length === 8 ? `https://papimo.jp/h/${value}/` : null },
                { key: 'P-moba_URL', name: 'P-moba', link: value => value },
                { key: 'P-do_ID', name: 'P-do', link: value => `https://www.p-do.ne.jp/k_mch.cgi?ln=${value}` },
                { key: 'P-ken_ID', name: 'P-ken', link: null },
                { key: 'P-tora_ID', name: 'P-tora', link: value => `https://p-tora.com/smafo/dedamajyoho-P-townDMMpachi/item.html?no=${value}` },
                { key: 'Star_ID', name: 'Star', link: null },
                { key: 'Reito_ID', name: 'Reito', link: value => `https://reitoweb.com/b_moba/doc/news.php?h=${value}` },
                { key: 'PrimeAI_ID', name: 'PrimeAI', link: value => `https://ukyaku.primeai.net/dedamajyoho-P-townDMMpachi/?hcode=${value}` },
                { key: 'P-ASSiST_URL', name: 'P-ASSiST', link: value => value },
                { key: 'LINE_ID', name: 'Star', link: null } // LINE_IDをStarとして
              ];
              
              customColumns.forEach(col => {
                const value = row[col.key] || '';
                if (!value) {
                  bodyRows += `<td>×</td>`;
                } else {
                  const parts = value.split('|').filter(p => p.trim());
                  let display = parts.map(p => {
                    let link = col.link ? col.link(p, row['Hall_Address']) : null;
                    return link ? `<a href="${link}" target="_blank">⚪︎</a>` : '⚪︎';
                  }).join(' ');
                  bodyRows += `<td>${display}</td>`;
                }
              });
              
              bodyRows += '</tr>';
            });
            document.getElementById('table-body').innerHTML = bodyRows;
          }
          
          // ローディング非表示
          document.getElementById('loading').style.display = 'none';
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('table-body').innerHTML = '<tr><td colspan="100%">データの取得に失敗しました。</td></tr>';
          document.getElementById('loading').style.display = 'none';
        });
    }
  </script>
</body>
</html>
